<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>サーバレス演習サイト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ここに API を固定したい場合だけ設定（例: https://xxx.execute-api.ap-northeast-1.amazonaws.com/Items またはベースURL） -->
  <meta name="api-url" content="<演習3で控えたapiUrl>/Items">
  <style>
    :root { --gap: 8px; --bd:#ccc; --font: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    body { text-align:center; font-family: var(--font); margin: 16px; }
    main { max-width: 960px; margin: 0 auto; }
    form { display:inline-flex; gap: var(--gap); flex-wrap: wrap; align-items: center; margin: 12px 0 16px; }
    table { margin:auto; border-collapse: collapse; width: min(100%, 860px); }
    td, th { border: 1px solid var(--bd); padding: 8px; }
    th { background: #fafafa; }
    input[type="text"], input[type="date"] { width: 180px; }
    button { margin: 0 2px; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  </style>
</head>
<body>
  <main>
    <h1>サーバレスアプリケーションへようこそ！</h1>

    <p id="apiInfo" aria-live="polite" style="margin:6px 0 0; font-size: 0.9rem;"></p>

    <form id="form" autocomplete="off" aria-describedby="apiInfo">
      <label class="sr-only" for="id">ID</label>
      <input id="id" name="id" placeholder="ID (任意の文字列)" required>
      <label class="sr-only" for="description">説明</label>
      <input id="description" name="description" placeholder="説明" required>
      <label class="sr-only" for="date">日付</label>
      <input id="date" name="date" type="date" required>
      <button type="submit">新規作成</button>
    </form>

    <h2>登録済みアイテム</h2>
    <table id="table" aria-describedby="apiInfo">
      <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col">説明</th>
          <th scope="col">日付</th>
          <th scope="col">操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script>
  (function(){
    "use strict";

    // --- API URL 解析（?api= または <meta name="api-url"> のいずれか） ---
    function normalizeItemsUrl(u) {
      if (!u) return "";
      u = u.replace(/\/+$/, "");
      // 末尾が /Items でなければ付与（大文字で統一）
      return /\/Items$/.test(u) ? u : (u + "/Items");
    }
    function resolveApiUrl() {
      const u = new URL(location.href);
      const fromQuery = u.searchParams.get("api");
      if (fromQuery) return normalizeItemsUrl(fromQuery);
      const meta = document.querySelector('meta[name="api-url"]')?.content?.trim();
      if (meta) return normalizeItemsUrl(meta);
      return "";
    }
    const apiUrl = resolveApiUrl();
    const apiInfo = document.getElementById("apiInfo");
    if (!apiUrl) {
      apiInfo.textContent = "APIエンドポイントが未設定です。<meta name=\"api-url\"> に演習4で控えた apiUrl の値を設定してください。";
    } else {
      apiInfo.style.display = "none"; // 正しく設定されていれば表示しない
    }

    // --- fetch ラッパ（10sタイムアウト、204/空レス対応） ---
    async function request(url, options = {}) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), 10_000);
      try {
        const res = await fetch(url, {
          headers: { "Content-Type": "application/json" },
          ...options, signal: controller.signal
        });
        const text = await res.text().catch(()=>"");
        if (!res.ok) throw new Error(text || `${res.status} ${res.statusText}`);
        return res.status === 204 ? null : (text ? JSON.parse(text) : null);
      } finally {
        clearTimeout(t);
      }
    }

    const $ = (sel, el=document) => el.querySelector(sel);
    const tbody = $("#table tbody");
    const form = $("#form");

    // --- 描画（一覧取得） ---
    async function draw() {
      if (!apiUrl) return;
      try {
        const items = await request(apiUrl) || [];
        tbody.innerHTML = "";
        for (const item of items) {
          const tr = document.createElement("tr");

          const tdId = document.createElement("td");
          tdId.textContent = item.id;

          const tdDesc = document.createElement("td");
          const inpDesc = document.createElement("input");
          inpDesc.type = "text";
          inpDesc.value = item.description ?? "";
          inpDesc.disabled = true;
          tdDesc.appendChild(inpDesc);

          const tdDate = document.createElement("td");
          const inpDate = document.createElement("input");
          inpDate.type = "date";
          inpDate.value = item.date ?? "";
          inpDate.disabled = true;
          tdDate.appendChild(inpDate);

          const tdOps = document.createElement("td");
          const btnEdit = document.createElement("button");
          btnEdit.type = "button";
          btnEdit.textContent = "編集";
          btnEdit.dataset.id = item.id;

          const btnDel = document.createElement("button");
          btnDel.type = "button";
          btnDel.textContent = "削除";
          btnDel.dataset.id = item.id;

          tdOps.append(btnEdit, btnDel);

          tr.append(tdId, tdDesc, tdDate, tdOps);
          tbody.appendChild(tr);
        }
      } catch (e) {
        alert("取得に失敗しました: " + e.message);
      }
    }

    // --- 行操作（編集↔保存／削除） ---
    tbody.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button");
      if (!btn) return;

      const tr = btn.closest("tr");
      const id = btn.dataset.id || tr?.firstElementChild?.textContent;
      if (!id) return;

      if (btn.textContent === "編集") {
        tr.querySelectorAll("input").forEach(i => i.disabled = false);
        btn.textContent = "保存";
        tr.querySelector("input")?.focus();
        return;
      }

      if (btn.textContent === "保存") {
        const description = tr.querySelector('input[type="text"]').value;
        const date = tr.querySelector('input[type="date"]').value;
        try {
          await request(`${apiUrl}/${encodeURIComponent(id)}`, {
            method: "PUT",
            body: JSON.stringify({ description, date })
          });
          await draw();
        } catch (e) {
          alert("更新に失敗しました: " + e.message);
        }
        return;
      }

      if (btn.textContent === "削除") {
        if (!confirm("本当に削除しますか？")) return;
        try {
          await request(`${apiUrl}/${encodeURIComponent(id)}`, { method: "DELETE" });
          await draw();
        } catch (e) {
          alert("削除に失敗しました: " + e.message);
        }
      }
    });

    // --- 新規作成 ---
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!apiUrl) return alert("APIエンドポイントを設定してください。");
      const id = $("#id").value.trim();
      const description = $("#description").value.trim();
      const date = $("#date").value;
      if (!id || !description || !date) return alert("id / 説明 / 日付 は必須です");
      try {
        await request(apiUrl, { method: "POST", body: JSON.stringify({ id, description, date }) });
        form.reset();
        await draw();
      } catch (e2) {
        alert("作成に失敗しました: " + e2.message);
      }
    });

    // 初期ロード
    window.addEventListener("DOMContentLoaded", draw);
  })();
  </script>
</body>
</html>
